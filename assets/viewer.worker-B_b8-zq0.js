(function(){"use strict";function H(C){console.log("createWorker");let x,d=0,M;const S=3*4+3*4+4+4;let U=[],I=new Uint32Array,T=0;var z=new Float32Array(1),W=new Int32Array(z.buffer);function L(r){z[0]=r;var l=W[0],y=l>>31&1,f=l>>23&255,s=l&8388607,i;return f==0?i=0:f<113?(i=0,s|=8388608,s=s>>113-f,s&16777216&&(i=1,s=0)):f<142?i=f-112:(i=31,s=0),y<<15|i<<10|s>>13}function F(r,l){return(L(r)|L(l)<<16)>>>0}function q(){if(!x)return;const r=new Float32Array(x),l=new Uint8Array(x);var y=1024*2,f=Math.ceil(2*d/y),s=new Uint32Array(y*f*4),i=new Uint8Array(s.buffer),_=new Float32Array(s.buffer);for(let a=0;a<d;a++){_[8*a+0]=r[8*a+0],_[8*a+1]=r[8*a+1],_[8*a+2]=r[8*a+2],i[4*(8*a+7)+0]=l[32*a+24+0],i[4*(8*a+7)+1]=l[32*a+24+1],i[4*(8*a+7)+2]=l[32*a+24+2],i[4*(8*a+7)+3]=l[32*a+24+3];let n=[r[8*a+3+0],r[8*a+3+1],r[8*a+3+2]],e=[(l[32*a+28+0]-128)/128,(l[32*a+28+1]-128)/128,(l[32*a+28+2]-128)/128,(l[32*a+28+3]-128)/128];const t=[1-2*(e[2]*e[2]+e[3]*e[3]),2*(e[1]*e[2]+e[0]*e[3]),2*(e[1]*e[3]-e[0]*e[2]),2*(e[1]*e[2]-e[0]*e[3]),1-2*(e[1]*e[1]+e[3]*e[3]),2*(e[2]*e[3]+e[0]*e[1]),2*(e[1]*e[3]+e[0]*e[2]),2*(e[2]*e[3]-e[0]*e[1]),1-2*(e[1]*e[1]+e[2]*e[2])].map((o,A)=>o*n[Math.floor(A/3)]),c=[t[0]*t[0]+t[3]*t[3]+t[6]*t[6],t[0]*t[1]+t[3]*t[4]+t[6]*t[7],t[0]*t[2]+t[3]*t[5]+t[6]*t[8],t[1]*t[1]+t[4]*t[4]+t[7]*t[7],t[1]*t[2]+t[4]*t[5]+t[7]*t[8],t[2]*t[2]+t[5]*t[5]+t[8]*t[8]];s[8*a+4]=F(4*c[0],4*c[1]),s[8*a+5]=F(4*c[2],4*c[3]),s[8*a+6]=F(4*c[4],4*c[5])}C.postMessage({texdata:s,texwidth:y,texheight:f},[s.buffer])}function D(r){if(!x)return;const l=new Float32Array(x);if(T==d){let n=U[2]*r[2]+U[6]*r[6]+U[10]*r[10];if(Math.abs(n-1)<.01)return}else q(),T=d;console.time("sort");let y=-1/0,f=1/0,s=new Int32Array(d);for(let n=0;n<d;n++){let e=(r[2]*l[8*n+0]+r[6]*l[8*n+1]+r[10]*l[8*n+2])*4096|0;s[n]=e,e>y&&(y=e),e<f&&(f=e)}let i=(256*256-1)/(y-f),_=new Uint32Array(256*256);for(let n=0;n<d;n++)s[n]=(s[n]-f)*i|0,_[s[n]]++;let a=new Uint32Array(256*256);for(let n=1;n<256*256;n++)a[n]=a[n-1]+_[n-1];I=new Uint32Array(d);for(let n=0;n<d;n++)I[a[s[n]]++]=n;console.timeEnd("sort"),U=r,C.postMessage({depthIndex:I,viewProj:r,vertexCount:d},[I.buffer])}function B(r){const l=new Uint8Array(r),y=new TextDecoder().decode(l.slice(0,1024*10)),f=`end_header
`,s=y.indexOf(f);if(s<0)throw new Error("Unable to read .ply file header");const i=parseInt(/element vertex (\d+)\n/.exec(y)[1]);console.log("Vertex Count",i);let _=0,a={},n={};const e={double:"getFloat64",int:"getInt32",uint:"getUint32",float:"getFloat32",short:"getInt16",ushort:"getUint16",uchar:"getUint8"};for(let p of y.slice(0,s).split(`
`).filter(u=>u.startsWith("property "))){const[u,g,h]=p.split(" "),w=e[g]||"getInt8";n[h]=w,a[h]=_,_+=parseInt(w.replace(/[^\d]/g,""))/8}console.log("Bytes per row",_,n,a);let t=new DataView(r,s+f.length),c=0;const o=new Proxy({},{get(p,u){if(!n[u])throw new Error(u+" not found");return t[n[u]](c*_+a[u],!0)}});console.time("calculate importance");let A=new Float32Array(i),V=new Uint32Array(i);for(c=0;c<i;c++){if(V[c]=c,!n.scale_0)continue;const p=Math.exp(o.scale_0)*Math.exp(o.scale_1)*Math.exp(o.scale_2),u=1/(1+Math.exp(-o.opacity));A[c]=p*u}console.timeEnd("calculate importance"),console.time("sort"),V.sort((p,u)=>A[u]-A[p]),console.timeEnd("sort");const m=3*4+3*4+4+4,v=new ArrayBuffer(m*i);console.time("build buffer");for(let p=0;p<i;p++){c=V[p];const u=new Float32Array(v,p*m,3),g=new Float32Array(v,p*m+4*3,3),h=new Uint8ClampedArray(v,p*m+4*3+4*3,4),w=new Uint8ClampedArray(v,p*m+4*3+4*3+4,4);if(n.scale_0){const b=Math.sqrt(o.rot_0**2+o.rot_1**2+o.rot_2**2+o.rot_3**2);w[0]=o.rot_0/b*128+128,w[1]=o.rot_1/b*128+128,w[2]=o.rot_2/b*128+128,w[3]=o.rot_3/b*128+128,g[0]=Math.exp(o.scale_0),g[1]=Math.exp(o.scale_1),g[2]=Math.exp(o.scale_2)}else g[0]=.01,g[1]=.01,g[2]=.01,w[0]=255,w[1]=0,w[2]=0,w[3]=0;if(u[0]=o.x,u[1]=o.y,u[2]=o.z,n.f_dc_0){const b=.28209479177387814;h[0]=(.5+b*o.f_dc_0)*255,h[1]=(.5+b*o.f_dc_1)*255,h[2]=(.5+b*o.f_dc_2)*255}else h[0]=o.red,h[1]=o.green,h[2]=o.blue;n.opacity?h[3]=1/(1+Math.exp(-o.opacity))*255:h[3]=255}return console.timeEnd("build buffer"),v}const k=()=>{if(!E){E=!0;let r=M;D(r),setTimeout(()=>{E=!1,r!==M&&k()},0)}};let E;C.onmessage=r=>{r.data.ply?(d=0,D(M),x=B(r.data.ply),d=Math.floor(x.byteLength/S),postMessage({buffer:x,save:!!r.data.save})):r.data.buffer?(x=r.data.buffer,d=r.data.vertexCount):r.data.vertexCount?d=r.data.vertexCount:r.data.view&&(M=r.data.view,k())}}H(self)})();
